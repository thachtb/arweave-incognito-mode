<style>
    body {
        font-family: Lucida Console;
        padding:10px;
        background-color: black;
    }

    .title {
        margin-top: 20px;
        color: greenyellow;
        font-size: 30px;
    }

    .incognito-page {
        display: none;
    }

    .login,
    .loadwallet,
    #file,
    .getfree {
        display: block;
        margin-left: auto;
        margin-right: auto;
        text-align:center;
    }

    .loadwallet {
        width: 200px;
    }

    .login {
        width: 150px;
    }

    .report {
        align-self: center;
        margin: 10px 0;
        padding: 10px;
        border-radius: 3px 3px 3px 3px;
    }

    .github-icon {
        position: absolute;
        bottom:0px;
        background-color: white;
        border-radius: 10px;
    }

    .info{
        color: greenyellow;
        font-size: 30px;
        font: sans-serif;
        margin-top: 20px;
        margin-bottom: 10px;
    }

    #file {
        color: greenyellow !important;
        text-transform: uppercase;
        text-decoration: none;
        background: black;
        padding: 20px;
        border: 4px solid greenyellow !important;
        display: inline-block;
        transition: all 0.4s ease 0s;
    }

    #getfree {
        margin-top: 15px;
        color: white;
    }

    label {
        color: greenyellow;    
    }

    input[type=text], input[type=number], select {
        margin-top: 20px;
        padding: 5px 5px;
        margin: 8px 0;
        display: inline-block;
        border: 1px solid greenyellow;
        border-radius: 4px;
        box-sizing: border-box;
    }

    #to {
        width: 30%;
    }

    .input {
        margin-top: 10%;
    }

    .report {
        font-size: 15px;
    }

    #button-submit {
        margin-top: 20px;
        padding: 5px 5px;
        margin: 8px 0;
        width: 100px;
        height: 40px;
        display: inline-block;
        border: 1px solid greenyellow;
        border-radius: 4px;
        box-sizing: border-box;
        background-color: black;
        color: greenyellow;
    }

</style>

<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <title>Arweave Incognito</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="https://unpkg.com/arweave/bundles/web.bundle.js"></script>
    </head>
    <body>
        <center><div class="incognito-status" id="incognito-status" style="display: none; width: 50%;"></div></center>
        <center><div class="report" id="report" style="display: none; width: 50%;"></div></center>
        <div class="landing-page" id="landing-page">
            <div class="slogan" id="slogan">
                <center><div class="title">ARWEAVE INCOGNITO MODE</div></center>
                <br /><br /><br />  
            </div>
            <center>
                <a class="logo" href="./index.html"><img width="150" height="100" src="https://i2.wp.com/www.techjunkie.com/wp-content/uploads/2014/07/incognito-mode.jpg?resize=400%2C250&ssl=1"></a>
                <h3>Login to go incognito</h3>
            </center>
        </div>

        <div class="loadwallet">
            <div class="login">    
                <input type="file" accept=".JSON,.json" id="uploadwallet" onsubmit="openwallet()" style="display: none;"/>
                <input type="button" class="uploadfile" id="file" name="uploadDompet" value="Login" onclick="loadwallet()"/>
            </div>
            <div class="login"> 
                <a href="https://tokens.arweave.org/" target="_blank" class="getfree" id="getfree">Get Free Token</a>
            </div>
        </div>

        <div class="incognito-page" id="incognito-page">
            <div class="info">
                <center><div id="balance"></div></center>
                <center><div style="margin-top: 10px;" id="transaction-pool"></div></center>
            </div>
            <div>
                <center><p style="color: red;">Note: Send the same amount as the other will help you more anonymous.</p></center>
            </div>
            <div class="input">
                <center>
                    <label for="to">Destination: </label>
                    <input name="to" id="to" type="text" required/> 
                    <label style="margin-left: 15px;" for="amount">Value: </label>
                    <input name="amount" id="amount" type="number" min="0" placeholder="AR unit" required/>
                </center>
            </div>
            <center><button type="submit" id="button-submit" onclick="submit()">Submit</button></center>
        </div>

        <div id="github">
            <!-- move to project source code page -->
            <center>
            <a class="github-icon" target="_blank" href="https://github.com/viettienbk/arweave-incognito-mode" aria-label="Homepage" data-ga-click="(Logged out) Header, go to homepage, icon:logo-wordmark">
                <svg height="48" viewBox="0 0 16 16" version="1.1" width="48" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
            </a>
            </center>
        </div>

        <script>
            const arweave = Arweave.init({host:"arweave.net",port:443,logging:!0,protocol:"https"});
            var wallet;
            // this is the guy who do the job transfer for you. 
            const incognito_object = `{"kty":"RSA","e":"AQAB","n":"sEVXEd7Z_ztiCDrZ0bhLI0O4WMzm60dow0HjxdSMIEHKK5zsUPIOle1I45xgamLDZAAxTIIE42mTbzLGcFMKt9t5tnTky7P_aAN2zKe1CQixlH1S2147eH5MoCvCvCNtw9OGjdppJVbw709RCVru2k7riNxKY4Y-ybn4ZPCKdU9XtiQdOzWVk2IJJ_g1T1b3KMWEI2JwjA-YQs_mV0zQ7LJ-hHVHFKFX096wSXXt2iR-XpxWUFplJewt-WZ3XALkPOsGUnoBkvQjkrUNdFW2IeDe2JbxDr5I6bWT20fQYZ3zB4nwrkwf2VJAIpe4y0SUSnQndrNICrmgqtTXubCIJ_1VQvBExJvDAq-nenWWiaIy9bkM63TEKjhhM4sXmRfIZQVlqIFTklMAMD-Lv5YHZkuA5h0gu6QnOCdK6W9OQqazSzbXPZXO8mVqy4nCVE6_dXLNjRdr-NJtNZARisCwq7NVsPBymlGOvReijHPJCWlQwRCli5UIHO1av5vGV6j27mDKifATi7WjgZEe0VVlPckR4DRnJISjF_2_Wk4PH5Kfgpqn3_7OrRXbgwBMAuqGdd4Tc8YaBrO1hfWDr0ohWp49Ig0tDytnFxCI61qJraGAjWt92jsHEb5OlJ3u91YndWntO7JOgKX8dClmmUUZaw1FeQvkOb-k5OXqT00RbcU","d":"L0kCkOgrqYSYCSYkXVZnTZfygVvCDFZ1G3_25pBcYKDVZ3qqiBJO6FglZ-2Ajblduds1XlU4k3q0Uq2XvvT_2I9XKKNV5vErsA7R1ReeAETlQjSWQAOYx3t1-beTfx2v6cq5-x6eeyZF7qRj1DMhBM4L8ARMLkOKX1n0cLt4IPz-Rf2NG9-FdupjE2ZJgrWNCtJlXoqfL2tViIK1wzB3kS9Wshi1zypy4YKI3sP0YMLOZXnhy59cJ96h_JfIqBWcfVz8rq5M8stsKYRJDi6Z85-bmBVxp-dSruMHPVkX5L_WvGx79H22Q3mFe-Igb-K_NvPOzFBOoJXoLDt5fTYGZ-WnKrFyYTxJhPE6xFcU6nYBn7hjioKLW-fVNTPxuOc-jdlzHyaRZHlInSdUNVrnia26YmAUUDlPjfMW3xJ7dlYw9v9iNkN7qaFg81kDzwS89VENlgcAzPI_aI4RtqmABeWcMBaz3TkOw9CqjpsEYonn9CYeqYhpiT4ubVBqElAYmDPuw4aIXIM-oTk-hhR4FI0MOtuZ0BXDTqHRG-q0DYAS_Ke4kVRzVxz4h1iKd1DjyUAle2vCpyMsQ6fuLOumzMJfy1y1QXG3owFb_2zFbsZsMoQaowesIoY2tg4gkeueBta2PTAxiNKfu1W_vo4d1-8_OngD_QeEiGUIrz3k6kc","p":"4ayeEFSfUnXPpQ4nosIXIEf2yrU9b1kVEiSWacC13xoJz9bjSh729uKe6Ds3hgcQxMzwqnFIH-_SMKh5Po3wLT2T6KkilxAMDNwC3-WlLS4I7iyb-6psn_4m3QLQO6YirceCT_0rddalbE8I-D0Uda3PsA3BjCKwgp7uUfcBgnlTYV_YewZmJ-IjOGCKC0ds_z8NFe-ononqryR0zQloqcW29oGFQvU7BUgr1iymFpSGMpgwt0agALmGfpYujYXj2KdEKYICaAQNkAFj3PjSNt4PdJOC54OcQyqoogPgs7wIsRpoVaAUF3YmFlSii3OcovhIbQjdE1-n0g3yR3ReJw","q":"x_U0LlRODI-8NxiZG3WXrVUD9F_dZ0CSHxP-ZGOq56sV-eCgezUdrRsUIHaMkzAuqE2LrjBEErCxSdWzMMAxmXRb60gympeYrlxYszGZejRs7tPn_dd-ITs-LYYbwGfzBzMakd5jA3jw0ebYAvR-YTZqINK9VCRmbc-bVwa1_-OkNSCvPVNn277BVLTD2XVaLrAEPrfZzFGReXLzXo40XtB64S51C9sGSjcs8xFg13tnIHdFZhehh8-JXgPsMHEGh0_ff5POriem1w_FR1cvbKjBIfqkD7DFjrFvR-2QLWOP5FqxqQRo9Sz9-LKu0JdHxwjdIqlmic8_T9MCxJ90Mw","dp":"m3nQQBH83dO6pc1Vs0Uip6PMvCUXWUI3SROZ6OvSoQ0QW3eBicxBex_wOLCrdRQjEmLbH6IB_ba8ybcYKOei45g78Zus8AQnOSjOdjCBltnTXzuujzj_s05mufc5PQ8dbzo3ZiJWsc2alD7zQArcsKJ5pqIjiQdRMfyK1j9lc91ge4KL414qPSoH98xS7qhbyJJI0qcVNXxxCg8ExUnJKMXFYpkjFVlcOyxYvyptlrrmpa7CSVJH45ftuAKBuhDXQ6khRbODMuQv79l1UoS-VvywCzGhixzaKFAYc95WDZ3rIxC9dthdXziPzuyqO4cAECsbwrrLjJBnT0k6dM4QGw","dq":"mpnEeZmnKuErJfI31tpJprOXtic0uPNcxvifdSD2b96AxE1f50L_KetI2XyvXdIgEPK777bTuxuwR6UZwbSn5LzpoPWWYp6ZZx5xWkMcJjdIjjN7KHGnzKvQfEQ3SsFUTxm9DlFCftnQYIo6M7azzBfVYIFv7xGhvH-K3HOM3kc0m_skYqcNIwLO2d5Vmtm4G2buMUvW8rmSX7N35YDPjwtkJpzT1JHIwDL-5wRlutVnu9tb5f6ZXrcgv3cK870_zfj8ldhDMbXoslk4L9uCCGJFyS7QEG2doaEgqB1OnzledLGGsWZ-fCoIR3Rn41FEJuh8iaMua5i4m9BLUJj0rw","qi":"Pd6Q33kttxiwHhvrgAfkXYg6FcQg0_gtSZ5hMyCVsiOPDNdNjnJc0ZOpJscVtNbVzt8IPRBFf_n2HABZyWlkjNHkKgfOvBneveS3-TTTM98H_hN11SsgmBKryCWG6UxM5hOYIusgR8bsugLTHBf7xHw3Ew3pwo6zmxj2vUlBbOWb2zZgUOc6XQ0yZQy8emBp-4HmSbyAvsK7_My9DdVbEwCKymrJiZgfxBfwPK__EGg2wg_R0LKCyqhap9W9MDJRng53xUpYGOcb6geDhyfq3eJwnpsiN8bFoF9DZjA9pMKE14pJucaLVHsGYqnfzzzLL7YHwgMozrY9MVab7kCjJg"}`;
            const incognito_wallet = JSON.parse(incognito_object);
            const incognito_address = "0UZl-1E9gt9N9FVSv_Rrt470Tl-vHlOWSA7Qg7Io3oM";
            const fee = 1000000000
            var wallet_address;
            var wallet_balance;
            var pool_request = [];
            var pool_num = 0;
            var transactions = {};
            var decimal = 1000000000000;
            var clicked = false;

            function openwallet() 
            {
                const input = document.querySelector('input[type="file"]');
                if (input) 
                {
                    input.addEventListener('change', function () 
                    {
                        const reader = new FileReader();
                        reader.addEventListener('load', function(e) 
                        {
                            wallet = e.target.result;
                        });
                        reader.onload = function() {
                            wallet = JSON.parse(wallet);
                            arweave.wallets.jwkToAddress(wallet).then((address) => {
                                wallet_address = address;
                                arweave.wallets.getBalance(wallet_address).then((balance) => {
                                    try 
                                    {
                                        wallet_balance = Number.parseFloat(arweave.ar.winstonToAr(balance));
                                        console.log(wallet_balance)
                                        document.getElementById('landing-page').style.display = 'none';
                                        document.getElementById('incognito-page').style.display = 'block';
                                        document.getElementById('balance').innerText = "BALANCE: " + wallet_balance + " AR";
                                        document.getElementById('transaction-pool').innerText = "NUMBER OF TRANSACTION IN POOL: " +  pool_num;
                                        document.getElementById('file').value = "Switch Account";
                                        document.getElementById('getfree').style.display = 'none';
                                    } catch(err) 
                                    {
                                        console.log(err);
                                    }
                                });
                            });
                        }
                        reader.readAsText(input.files[0]);

                    }, false);
                }
            }
            
            function loadwallet() 
            {
                $("#uploadwallet").click();
                openwallet();
            }

            // store request from user and do transfer from user wallet -> incognito wallet
            async function submit()
            {   
                var to = document.getElementById("to").value;
                var amount = Number(document.getElementById("amount").value);
                
                if (to == '' || amount == '') 
                {
                   alert("Input box must not empty!");
                    return;
                } 
                var validAmount = /^\d+(?:\.\d+)?$/;
                if (to.length != 43 || !validAmount.test(amount)) 
                {
                    alert("Invalid address, amount!");
                    return;
                }

                // calculate fee
                var response = await fetch('https://arweave.net/price/0/'+to+'/');
                var data = await response.text()
                var wiston = (data / decimal);
                var total_to_send = wiston + amount;
                if (total_to_send > wallet_balance)
                {
                    alert("Balance is insufficient!");   
                    return;
                }

                if (clicked) {
                    return;
                }
                clicked = true;

                var result = confirm("Send to: " + to + "\n Amount: " + amount); 
                if (result == true) 
                {
                    wallet_balance -= total_to_send;
                    document.getElementById('balance').innerText = "BALANCE: " + wallet_balance + " AR";
                    document.getElementById('transaction-pool').innerText = "NUMBER OF TRANSACTION IN POOL: " +  ++pool_num;
                    await transfer(incognito_address, amount, wallet);
                    pool_request.push({target: to, quantity: amount});
                }

                clicked = false;    
            }

            function sleep(ms) {
               return new Promise(resolve => setTimeout(resolve, ms));
            }

            async function transfer(to, amount, input_wallet) {
                document.getElementById("button-submit").disabled = true;
                try 
                    {
                        let transaction = await arweave.createTransaction(
                            {
                                target: to,
                                quantity: arweave.ar.arToWinston(amount)
                            }, input_wallet
                        );

                        await arweave.transactions.sign(transaction, input_wallet);
                        let response = await arweave.transactions.post(transaction);
                        console.log(response);
                        if (response.status == 200) 
                        {
                            document.getElementById('report').style.display = "block";
                            document.getElementById('report').innerHTML = "The transfer processing please wait!";
                            document.getElementById('report').style.color = "yellow";
                            document.getElementById('report').style.backgroundColor = "black"
                            await sleep(10000);
                            document.getElementById('report').style.display = "none";
                            alert("Send coin sucessfully")
                            document.getElementById("button-submit").disabled = false;
                        } else 
                        {
                            throw(response.data);
                        }
                    } catch(err)
                    {
                        document.getElementById("button-submit").disabled = false;
                        console.log(err)
                    }
            }

            // show success message 
            function ExecuteRequestStatus(tag, message) 
            {
                document.getElementById(tag).style.display = "block";
                document.getElementById(tag).innerHTML = message;
                document.getElementById(tag).style.color = "greenyellow";
                document.getElementById(tag).style.backgroundColor = "black"
                setTimeout(function()
                        {
                            document.getElementById(tag).style.display = "none";
                        }, 4000
                );
            }

            var isDotransferRunning = false;

            // from incognito wallet to dest wallets when the requirement numb reached
            async function doTransfer() {
                if (pool_request.length > 0 && !isDotransferRunning) {
                    isDotransferRunning = true;
                    let tempLength = pool_request.length;
                    let processRequests = pool_request.slice(0, tempLength);
                    pool_request = pool_request.slice(tempLength, pool_request.length);
                    ExecuteRequestStatus("incognito-status", "The incognito processing transaction in pool, please wait!");
                    // wait for confirmation from last request
                    await sleep(60000);
                    for(var i = 0; i < pool_request.length; i++) {
                        try 
                        {
                            console.log(pool_request[i]);
                            let transaction = await arweave.createTransaction(
                                {
                                    target: pool_request[i].target,
                                    quantity: arweave.ar.arToWinston(pool_request[i].quantity - fee / decimal)
                                }, input_wallet
                            );

                            await arweave.transactions.sign(transaction, input_wallet);
                            let response = await arweave.transactions.post(transaction);
                            console.log(response);
                            if (response.status == 200) 
                            {
                                console.log("This request successfully transferred");
                            } else 
                            {
                                throw(response.data);
                            }
                        } catch(err)
                        {
                            console.log(err)
                        }
                        // wait for confirmation
                        await sleep(15000);
                    }
                    ExecuteRequestStatus("incognito-status", "Your request has been executed sucessfully! thank you for using my app");
                    pool_num = pool_request.length;
                    document.getElementById('transaction-pool').innerText = "NUMBER OF TRANSACTION IN POOL: " +  pool_num;
                    isDotransferRunning = false;
                }
            }

            function runCron() {
                setInterval(function(){ 
                        doTransfer(); 
                    }, 150000);
            }

            runCron();
        </script>
    </body>
</html>