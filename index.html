<style>
    body {
        font-family: Lucida Console;
        padding:10px;
        background-color: black;
    }

    .title {
        margin-top: 20px;
        color: greenyellow;
        font-size: 30px;
    }

    .incognito-page {
        display: none;
    }

    .login,
    .loadwallet,
    #file,
    .getfree {
        display: block;
        margin-left: auto;
        margin-right: auto;
        text-align:center;
    }

    .loadwallet {
        width: 200px;
    }

    .login {
        width: 150px;
    }

    .report {
        align-self: center;
        margin: 10px 0;
        padding: 10px;
        border-radius: 3px 3px 3px 3px;
    }

    .github-icon {
        position: absolute;
        bottom:0px;
        background-color: white;
        border-radius: 10px;
    }

    .info{
        color: greenyellow;
        font-size: 30px;
        font: sans-serif;
        margin-top: 20px;
        margin-bottom: 10px;
    }

    #file {
        color: greenyellow !important;
        text-transform: uppercase;
        text-decoration: none;
        background: black;
        padding: 20px;
        border: 4px solid greenyellow !important;
        display: inline-block;
        transition: all 0.4s ease 0s;
    }

    #getfree {
        margin-top: 15px;
        color: white;
    }

    label {
        color: greenyellow;    
    }

    input[type=text], input[type=number], select {
        margin-top: 20px;
        padding: 5px 5px;
        margin: 8px 0;
        display: inline-block;
        border: 1px solid greenyellow;
        border-radius: 4px;
        box-sizing: border-box;
    }

    #to {
        width: 30%;
    }

    .input {
        margin-top: 10%;
    }

    .report {
        font-size: 15px;
    }

    .incognito-status {
        margin: 5px;
        padding: 5px;
    }

    #button-submit {
        margin-top: 20px;
        padding: 5px 5px;
        margin: 8px 0;
        width: 100px;
        height: 40px;
        display: inline-block;
        border: 1px solid greenyellow;
        border-radius: 4px;
        box-sizing: border-box;
        background-color: black;
        color: greenyellow;
    }

</style>

<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <title>Arweave Incognito</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="https://unpkg.com/arweave/bundles/web.bundle.js"></script>
    </head>
    <body>
        <center><div class="incognito-status" id="incognito-status" style="display: none; width: 50%;"></div></center>
        <center><div class="report" id="report" style="display: none; width: 50%;"></div></center>
        <div class="landing-page" id="landing-page">
            <div class="slogan" id="slogan">
                <center><div class="title">ARWEAVE INCOGNITO MODE</div></center>
                <br /><br /><br />  
            </div>
            <center>
                <a class="logo" href="./index.html"><img width="150" height="100" src="https://i2.wp.com/www.techjunkie.com/wp-content/uploads/2014/07/incognito-mode.jpg?resize=400%2C250&ssl=1"></a>
                <h3>Login to go incognito</h3>
            </center>
        </div>

        <div class="loadwallet">
            <div class="login">    
                <input type="file" accept=".JSON,.json" id="uploadwallet" onsubmit="openwallet()" style="display: none;"/>
                <input type="button" class="uploadfile" id="file" name="uploadDompet" value="Login" onclick="loadwallet()"/>
            </div>
            <div class="login"> 
                <a href="https://tokens.arweave.org/" target="_blank" class="getfree" id="getfree">Get Free Token</a>
            </div>
        </div>

        <div class="incognito-page" id="incognito-page">
            <div class="info">
                <center><div id="balance"></div></center>
                <center><div style="margin-top: 10px;" id="transaction-pool"></div></center>
            </div>
            <div>
                <center><p style="color: red;">Note: Send the same amount as the other will help you more anonymous.</p></center>
            </div>
            <div class="input">
                <center>
                    <label for="to">Destination: </label>
                    <input name="to" id="to" type="text" required/> 
                    <label style="margin-left: 15px;" for="amount">Value: </label>
                    <input name="amount" id="amount" type="number" min="0" placeholder="AR unit" required/>
                </center>
            </div>
            <center><button type="submit" id="button-submit" onclick="submit()">Submit</button></center>
        </div>

        <div id="github">
            <!-- move to project source code page -->
            <center>
            <a class="github-icon" target="_blank" href="https://github.com/viettienbk/arweave-incognito-mode" aria-label="Homepage" data-ga-click="(Logged out) Header, go to homepage, icon:logo-wordmark">
                <svg height="48" viewBox="0 0 16 16" version="1.1" width="48" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
            </a>
            </center>
        </div>

        <script>
            const arweave = Arweave.init({host:"arweave.net",port:443,logging:!0,protocol:"https"});
            var wallet;
            // this is the guy who do the job transfer for you. 
            const incognito_wallet =  {"kty":"RSA","e":"AQAB","n":"lXtzWYZoabDCGi_8GuNi3h1OfegK3d11kAeeBkgV0shK3SKqCV-BbGfXjqk72S2ywryv2sORZY1KbpHOLfxYFhTgtRwInx524Q92m8wdjP2wkv9x-RHe6xYNSBTAGREM_wq15H2c7_l4j85JYtIpwvcVEwp0V3dJ-v4yi2NNi_kfxprHgY1ZGxb17UvhJvAXr63lGdZ3GfSfk7oe0S5cCcWOugPvnHCrmYxkgn8j9FgvDJ1VMwAYnivIe9XrGLFp0_bDfSSKy-lLgcueJKE_8gLRYCgTYuuXn0zJPY4JBUZh0p2q1UCNbTnVspxwcQEf8YGYG81RDZKQRj5J5OJ6fnbF7M-L-WC13nXUmFazOtMZbzLW-JvQIEexh9YZKd1HPUYOZiUtnecaAJXWw-BeKxrlE-dkPIjYq2DNLA7r88HdnYto8zBZB19E0J4YvhWgGO-fZM4dQV353uPKcF1ShrgidI-plsU2U0jbnA7HAA4TUvD1c55dAiZzrEQVUomgPlBde60mrvlRFbR-YhKQ8md5h057sZm4CL_jaqGJ7HK65V0iTxd2TryKVPdd-vmEZ2s2Tior1FRvqMvVblBOm8oz-lWTUF6ElaYrl74CrknSoVE9IazwxEopQ0DeliGIhaAZICqZRNTeErHT0vh1oSjJP1Xb_M2yjYi9PQkgfqs","d":"LNrN6qu_0hMls3j5o9HenXrazkIeXKPy_oSioQzpa4YJnOCleEmNyws_7gGPQWSKkw_Ojw0HKJtkndgnr7ncbsfWA9KFLcYU8wTSWP6_UUrgvMNlHlGD_DPySVJcsEjjBvbeTNF6kbHgwPosIDijKms9CiklbwePDf9QCG6EWv-mztAsFI5nEg9qPUn7JlV-Lgu2xvGJbKLwbYI4dBl-qbn70YqT0HQosdskX9op3kzF1XmykqqxOGk38BzpPlAiSuXtlDQuZ_C55RlF-4TdbM_2pu1vn8vFBBqk-lEQGOKdQPdpxzLnHULxAncZ8HbfcHcsPw91hmaX31QalVF2Yt3krFzvr_RNOYFzRguIkDP3fz-1lCRqzPRFhuqSLT7JNfmvikrFXXZZ9HHgH9YsdKAXvJNPveJH7L8RQi6xkNx741vfr_2vHaRVWaq3v80t5P_LBIKI88SgalxAudfyBEPPdYbVnlpQgTXnF4eyfQbpL_ooQAt1OdMPGlQYoAwxnVQAQwXIDUdW8J8Eyb6NOgy029s3wCDX1f7Te0ynPmuHy63hT5tZ-XmgQdPXofp6Qelffxv8YPVHQHLMSM24DnU9NGjGmQjt6pSttVIhWtgepi9mHN_8DnKJSAhHKPkqdXITpSB2xsqjqucuwmjmbSdvA3d4Lce1EVixK360B90","p":"yq6b6Bcyo9bQCxvEv86TRGxAu6QwdXZLf0y88zAPS5N4TccIuYXW-PV3FH5wCAFWpdrgDrUYMbMm0IUAQxE4tbmN2mGbr_s0kcVMrwjoZT-zhmFVh-vW0uf3_snqUYPG95PkXOQKsi3abXMlOczLW1Ytfa7jJWiu1WE7512tLypCTYTkn3jJa3u4y4-yGsL_okKbdVlwE7to4RfDPR443j1uNGiqnJNNNpsf55VaP86wf2J9QCyBodHkeUD025THs_iOm8dSz43yk_CYO0PcnPhmLoteqsGYsvMeO78yhygdlV64lYZXPZ1R0pXsaO6_2Zu8_o2gFNGy20xRnAnp_Q","q":"vM4o3DVL_MDiPS0EKTsBJsKKcIxuKInjRUQ2llN7AUIWuPQwQGHmwyPHOyIPdY3nH7yMtGtN1zKnAIieWlYu-eFY9wE8_hVwz_9jcNLXBjMoQFwsFpZ0rtpu_8dDj_jLJRpUhXIA5XC8ueWBvK328y_SI48EstCMkJ51gGfzFaP9H2SLE5nz6FEYzT0EoX2pA0jC4WK6bJv2qEcRFoCouD2PCa2TQxDRTDehyMxwFvw4TyQLZXojs6Kr7ughqhZc1YuA_zoNHuuoCvF7Aw8MLwX0HDbU88LyxgvZYThx5hT_86WD2VBoT1tKG1euV2-Gjt1i6PP2wX-AH3M4qXN3xw","dp":"rC3tMBsU3-5KykUKvU7F-GhmDYGL0R1vQXN1SLpZJADhQGGG3eP_HXuZb4WBsqtAaqEnmhbpuL7SiG2ULWVh4a8B_LTSx4sFu5f6bu-ITQryfYQOXutQkdaR7JanQhxKWGQAqZDoLTmax0P8Kb_6OVtaRdzeBheJ_qcddo0z5E9oB-aPOZIoufBeqj8mNGnXNIaU_fm-pmSc0iuXpkIYWWOiTU9lMKJKA8uALQHJq07wzSZj9LJaZZejGga-fBNGG3NZ4qhPhxa1LkxDZoVd0tOKKpwnDbRs_ghedK8WQ48moo_XCt8XGbadneHS9clsnXYZ9b1mcok6AeYxpfceGQ","dq":"gAEFksZPjjz3JaKvf4SRc0XRthx_UtypSPzGRYSzkFbOMPbc_8lgOky3dk_RS1G5sLqUan2VeKDOuH3nXjewAZnWRyB_yYOfyGTNdmB7h6iHUZssCORYl3Ngbeka1TFICQ-g3hg8o1Gboi0HmHQZSSbSwWjlNpZNtn64CyZul-1mXzI7WD64LnlM51jHGvWm8KMT_NqCqb_TqqMD4s23lbGmmFklzgJI4_OTrB9unybAxmcZkuML8W4IQyD-MeKXbe_2tRMWcjAy7bhqPdil2fufVMGX_uvczIicCF3MWsFCBl3g1iS9k4_A3mjDumPSRmmx9V3xnZ5jru7fK4MtYQ","qi":"KxaINnPIW5sFSoWydFO0PzUgwG-07orEwWkvUkxnC9MdyzmNPduKy7bY2Hs5_4CKjIwtqaBEBt2QTwfOmnNgf_P0vcBXNC-J6VSGRuKlZ3CmfirHW2n3UkDsPvz_7l2RRldqQXdWiRXF4qwwww6d_vpUl2BlK2wseuTR9A_SsPEVxdI2OPil7hW2e8hjuMqPL8-BLTcH5d7Qi6ofgflfF6v4czkuUUGis0gkjI7CQ7DX2qhLCeFxaTVu_QpmJM3i_pN6IDZm4sJuqrJVHz38Zi2Be2cncXNWArkNdPkoJHD0t5fw-ZjjxCr2hUZh6CMZ1q1w0vLGG2RinHLArFvA9Q"};           
            const incognito_address = "khCYRvuROTyWggh_eh7fflq3Nc8l3BN93FJohTppGZA";
            const fee = 900000000
            var wallet_address;
            var wallet_balance;
            var pool_request = [];
            var pool_num = 0;
            var transactions = {};
            var decimal = 1000000000000;
            var clicked = false;

            function openwallet() 
            {
                const input = document.querySelector('input[type="file"]');
                if (input) 
                {
                    input.addEventListener('change', function () 
                    {
                        const reader = new FileReader();
                        reader.addEventListener('load', function(e) 
                        {
                            wallet = e.target.result;
                        });
                        reader.onload = function() {
                            wallet = JSON.parse(wallet);
                            arweave.wallets.jwkToAddress(wallet).then((address) => {
                                wallet_address = address;
                                arweave.wallets.getBalance(wallet_address).then((balance) => {
                                    try 
                                    {
                                        wallet_balance = Number.parseFloat(arweave.ar.winstonToAr(balance));
                                        document.getElementById('landing-page').style.display = 'none';
                                        document.getElementById('incognito-page').style.display = 'block';
                                        document.getElementById('balance').innerText = "BALANCE: " + wallet_balance + " AR";
                                        document.getElementById('transaction-pool').innerText = "NUMBER OF TRANSACTION IN POOL: " +  pool_num;
                                        document.getElementById('file').value = "Switch Account";
                                        document.getElementById('getfree').style.display = 'none';
                                    } catch(err) 
                                    {
                                        console.log(err);
                                    }
                                });
                            });
                        }
                        reader.readAsText(input.files[0]);

                    }, false);
                }
            }
            
            function loadwallet() 
            {
                $("#uploadwallet").click();
                openwallet();
            }

            // store request from user and do transfer from user wallet -> incognito wallet
            async function submit()
            {   
                var to = document.getElementById("to").value;
                var amount = Number(document.getElementById("amount").value);
                
                if (to == '' || amount == '') 
                {
                   alert("Input box must not empty!");
                    return;
                } 
                var validAmount = /^\d+(?:\.\d+)?$/;
                if (to.length != 43 || !validAmount.test(amount)) 
                {
                    alert("Invalid address, amount!");
                    return;
                }

                // calculate fee
                var response = await fetch('https://arweave.net/price/0/'+to+'/');
                var data = await response.text()
                var wiston = (data / decimal);
                var total_to_send = wiston + amount;
                if (total_to_send > wallet_balance)
                {
                    alert("Balance is insufficient!");   
                    return;
                }

                if (clicked) {
                    return;
                }
                clicked = true;

                var result = confirm("Send to: " + to + "\n Amount: " + amount); 
                if (result == true) 
                {
                    await transfer(to, amount, wallet, total_to_send);
                }

                clicked = false;    
            }

            function sleep(ms) {
               return new Promise(resolve => setTimeout(resolve, ms));
            }

            async function transfer(to, amount, input_wallet, total) {
                document.getElementById("button-submit").disabled = true;
                try 
                    {
                        let transaction = await arweave.createTransaction(
                            {
                                target: incognito_address,
                                quantity: arweave.ar.arToWinston(amount)
                            }, input_wallet
                        );

                        await arweave.transactions.sign(transaction, input_wallet);
                        let response = await arweave.transactions.post(transaction);
                        console.log(response);
                        if (response.status == 200) 
                        {
                            document.getElementById('report').style.display = "block";
                            document.getElementById('report').innerHTML = "Processing your request please wait!";
                            document.getElementById('report').style.color = "yellow";
                            document.getElementById('report').style.backgroundColor = "black"
                            await sleep(10000);
                            document.getElementById('report').style.display = "none";
                            alert("Send coin sucessfully")
                            document.getElementById("button-submit").disabled = false;
                            wallet_balance -= total;
                            document.getElementById('balance').innerText = "BALANCE: " + wallet_balance + " AR";
                            document.getElementById('transaction-pool').innerText = "NUMBER OF TRANSACTION IN POOL: " +  ++pool_num;
                            pool_request.push({target: to, quantity: amount});
                        } else 
                        {
                            throw(response.data);
                        }
                    } catch(err)
                    {
                        document.getElementById("button-submit").disabled = false;
                        console.log(err)
                    }
            }

            // show success message 
            function ExecuteRequestStatus(tag, message) 
            {
                document.getElementById(tag).style.display = "block";
                document.getElementById(tag).innerHTML = message;
                document.getElementById(tag).style.color = "greenyellow";
                document.getElementById(tag).style.backgroundColor = "black"
                setTimeout(function()
                        {
                            document.getElementById(tag).style.display = "none";
                        }, 4000
                );
            }

            var isDotransferRunning = false;

            // from incognito wallet to dest wallets
            async function doTransfer() {
                if (pool_request.length > 0 && !isDotransferRunning) {
                    isDotransferRunning = true;
                    let tempLength = pool_request.length;
                    let processRequests = pool_request.slice(0, tempLength);
                    pool_request = pool_request.slice(tempLength, pool_request.length);
                    ExecuteRequestStatus("incognito-status", "The incognito processing transaction in pool!");
                    // wait for confirmation from last request
                    await sleep(60000);
                    for(var i = 0; i < processRequests.length; i++) {
                        try 
                        {
                            let transaction = await arweave.createTransaction(
                                {
                                    target: processRequests[i].target,
                                    quantity: arweave.ar.arToWinston(processRequests[i].quantity - fee / decimal)
                                }, incognito_wallet
                            );
                            await arweave.transactions.sign(transaction, incognito_wallet);
                            let response = await arweave.transactions.post(transaction);
                            console.log(response);
                            if (response.status == 200) 
                            {
                                console.log("This request successfully transferred");
                            } else 
                            {
                                throw(response.data);
                            }
                        } catch(err)
                        {
                            console.log(err)
                        }
                        // wait for confirmation
                        await sleep(15000);
                    }
                    ExecuteRequestStatus("incognito-status", "Your request has been executed sucessfully! thank you for using my app");
                    pool_num = pool_request.length;
                    document.getElementById('transaction-pool').innerText = "NUMBER OF TRANSACTION IN POOL: " +  pool_num;
                    isDotransferRunning = false;
                }
            }

            function runCron() {
                setInterval(function(){ 
                        doTransfer(); 
                    }, 150000);
            }

            runCron();
        </script>
    </body>
</html>